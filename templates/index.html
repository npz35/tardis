<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TARDIS - PDF翻訳Webアプリ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1 class="logo">TARDIS</h1>
                <p class="tagline">PDF翻訳Webアプリ</p>
            </div>
        </header>

        <main class="main">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </div>
                    <h2>PDFファイルをアップロード</h2>
                    <p class="upload-text">ドラッグ＆ドロップまたはクリックしてファイルを選択</p>
                    <p class="upload-hint">対応形式: PDFファイル（最大16MB）</p>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <button class="operation-button" id="selectButton">ファイルを選択</button>
                </div>

                <div class="file-info" id="fileInfo" style="display: none;">
                    <div class="file-details">
                        <div class="file-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </div>
                        <div class="file-meta">
                            <p class="file-name" id="fileName"></p>
                            <p class="file-size" id="fileSize"></p>
                        </div>
                        <button class="remove-button" id="removeButton">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button class="operation-button" id="columnSeparationButton"
                            style="display: none;">段組み分離</button>
                        <button class="operation-button" id="areaColoringButton" style="display: none;">領域色分け</button>
                        <button class="operation-button" id="extractTextButton" style="display: none;">テキスト抽出</button>
                        <button class="operation-button" id="translateTextButton" style="display: none;">テキスト翻訳</button>
                        <button class="operation-button" id="figureButton" style="display: none;">図表抽出</button>
                        <button class="operation-button" id="drawTextButton" style="display: none;">翻訳</button>
                        <button class="operation-button" id="healthButton" style="display: none;">Healthチェック</button>
                    </div>
                </div>
            </div>

            <div class="translation-section" id="translationSection" style="display: none;">
                <div class="translation-header">
                    <h2>翻訳処理中</h2>
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">準備中...</span>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progressText">0%</span>
                    </div>
                </div>

                <div class="translation-steps">
                    <div class="step" id="step1">
                        <div class="step-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M11 17.25a6.25 6.25 0 1 0 0-12.5 6.25 6.25 0 0 0 0 12.5ZM16 16l4.5 4.5"></path>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-main-info">
                                <div class="step-progress">0%</div>
                                <h3>PDF解析</h3>
                                <p>PDFファイルを解析してテキストを抽出中...</p>
                            </div>
                        </div>
                    </div>

                    <div class="step" id="step2">
                        <div class="step-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-main-info">
                                <div class="step-progress">0%</div>
                                <h3>テキスト結合</h3>
                                <p>抽出したテキストを意味単位で結合中...</p>
                            </div>
                        </div>
                    </div>

                    <div class="step" id="step3">
                        <div class="step-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="17 1 21 5 17 9"></polyline>
                                <path d="M3 12h18"></path>
                                <polyline points="7 23 3 19 7 15"></polyline>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-main-info">
                                <div class="step-progress">0%</div>
                                <h3>翻訳処理</h3>
                                <p>LLMによる翻訳処理中...</p>
                            </div>
                        </div>
                    </div>

                    <div class="step" id="step4">
                        <div class="step-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-main-info">
                                <div class="step-progress">0%</div>
                                <h3>レイアウト調整</h3>
                                <p>翻訳結果を元のレイアウトに配置中...</p>
                            </div>
                        </div>
                    </div>

                    <div class="step" id="step5">
                        <div class="step-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-main-info">
                                <div class="step-progress">0%</div>
                                <h3>PDF生成</h3>
                                <p>翻訳済みPDFを生成中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="result-section" id="resultSection" style="display: none;">
                <div class="result-header">
                    <h2>翻訳完了</h2>
                    <div class="result-stats">
                        <div class="stat-item">
                            <span class="stat-label">処理時間</span>
                            <span class="stat-value" id="processingTime">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">翻訳ユニット数</span>
                            <span class="stat-value" id="translatedUnits">-</span>
                        </div>
                    </div>
                </div>

                <div class="result-actions">
                    <button class="download-button" id="downloadButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        翻訳済みPDFをダウンロード
                    </button>
                    <button class="new-button" id="newButton">新しいファイルを翻訳</button>
                </div>

                <div class="result-preview">
                    <h3>プレビュー</h3>
                    <div class="preview-container">
                        <iframe id="pdf-preview" style="width:100%; height:500px; border:none; display:none;"
                            allow="fullscreen"></iframe>
                        <div class="preview-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                            </svg>
                        </div>
                    </div>
                    <a id="download-pdf" href="#" class="button" style="display:none;" download>翻訳済みPDFをダウンロード</a>
                </div>

                <div class="extracted-text-display" id="extractedTextDisplay" style="display: none;">
                    <h3>抽出されたテキスト</h3>
                    <pre id="extractedTextContent"></pre>
                </div>
        </main>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <script>
            const socket = io();

            socket.on('connect', function () {
                console.log('Connected to Socket.IO server');
            });

            socket.on('progress', function (data) {
                console.log('Progress received:', data.percentage, 'Step:', data.step);
                updateProgress(data.percentage, data.step);
            });

            // Click event for the file selection button
            document.getElementById('selectButton').addEventListener('click', function () {
                document.getElementById('fileInput').click();
            });

            // Event when a file is selected
            document.getElementById('fileInput').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    // ファイル情報を表示する
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileSize').textContent = formatFileSize(file.size);
                    document.getElementById('fileInfo').style.display = 'block';

                    // アップロードエリアを非表示にする
                    document.getElementById('uploadArea').style.display = 'none';
                    // 表示
                    document.getElementById('columnSeparationButton').style.display = 'block';
                    document.getElementById('areaColoringButton').style.display = 'block';
                    document.getElementById('extractTextButton').style.display = 'block';
                    document.getElementById('translateTextButton').style.display = 'block';
                    document.getElementById('figureButton').style.display = 'block';
                    document.getElementById('drawTextButton').style.display = 'block';
                    document.getElementById('healthButton').style.display = 'block';

                    // 選択されたファイルを保存する
                    window.selectedFile = file;
                }
            });

            // Click event for the figure button
            document.getElementById('figureButton').addEventListener('click', function () {
                const file = window.selectedFile;
                if (file) {
                    // 翻訳セクションを表示する
                    document.getElementById('translationSection').style.display = 'block';
                    // 非表示
                    document.getElementById('columnSeparationButton').style.display = 'none';
                    document.getElementById('areaColoringButton').style.display = 'none';
                    document.getElementById('extractTextButton').style.display = 'none';
                    document.getElementById('translateTextButton').style.display = 'none';
                    document.getElementById('figureButton').style.display = 'none';
                    document.getElementById('drawTextButton').style.display = 'none';
                    document.getElementById('healthButton').style.display = 'none';
                    // デバッグ処理を開始する
                    startFigureProcess(file);
                } else {
                    alert('選択されていません');
                }
            });

            // Click event for the text extraction button
            document.getElementById('extractTextButton').addEventListener('click', function () {
                const file = window.selectedFile;
                if (file) {
                    // 翻訳セクションを表示する
                    document.getElementById('translationSection').style.display = 'block';
                    // 非表示
                    document.getElementById('columnSeparationButton').style.display = 'none';
                    document.getElementById('areaColoringButton').style.display = 'none';
                    document.getElementById('extractTextButton').style.display = 'none';
                    document.getElementById('translateTextButton').style.display = 'none';
                    document.getElementById('figureButton').style.display = 'none';
                    document.getElementById('drawTextButton').style.display = 'none';
                    document.getElementById('healthButton').style.display = 'none';
                    // テキスト抽出処理を開始する
                    startExtractTextProcess(file);
                } else {
                    alert('選択されていません');
                }
            });

            // Click event for the text translation button
            document.getElementById('translateTextButton').addEventListener('click', function () {
                const file = window.selectedFile;
                if (file) {
                    // 翻訳セクションを表示する
                    document.getElementById('translationSection').style.display = 'block';
                    // 非表示
                    document.getElementById('columnSeparationButton').style.display = 'none';
                    document.getElementById('areaColoringButton').style.display = 'none';
                    document.getElementById('extractTextButton').style.display = 'none';
                    document.getElementById('translateTextButton').style.display = 'none';
                    document.getElementById('figureButton').style.display = 'none';
                    document.getElementById('drawTextButton').style.display = 'none';
                    document.getElementById('healthButton').style.display = 'none';
                    // テキスト翻訳処理を開始する
                    startTranslateTextProcess(file);
                } else {
                    alert('選択されていません');
                }
            });

            // Click event for the draw text button
            document.getElementById('drawTextButton').addEventListener('click', function () {
                const file = window.selectedFile;
                if (file) {
                    // 翻訳セクションを表示する
                    document.getElementById('translationSection').style.display = 'block';
                    // 非表示
                    document.getElementById('columnSeparationButton').style.display = 'none';
                    document.getElementById('areaColoringButton').style.display = 'none';
                    document.getElementById('extractTextButton').style.display = 'none';
                    document.getElementById('translateTextButton').style.display = 'none';
                    document.getElementById('figureButton').style.display = 'none';
                    document.getElementById('drawTextButton').style.display = 'none';
                    document.getElementById('healthButton').style.display = 'none';
                    // 翻訳処理を開始する
                    startDrawTextProcess(file);
                } else {
                    alert('選択されていません');
                }
            });

            // Click event for the area coloring button
            document.getElementById('areaColoringButton').addEventListener('click', function () {
                const file = window.selectedFile;
                if (file) {
                    // 翻訳セクションを表示する
                    document.getElementById('translationSection').style.display = 'block';
                    // 非表示
                    document.getElementById('columnSeparationButton').style.display = 'none';
                    document.getElementById('areaColoringButton').style.display = 'none';
                    document.getElementById('extractTextButton').style.display = 'none';
                    document.getElementById('translateTextButton').style.display = 'none';
                    document.getElementById('figureButton').style.display = 'none';
                    document.getElementById('drawTextButton').style.display = 'none';
                    document.getElementById('healthButton').style.display = 'none';
                    // 領域色分け処理を開始する
                    startAreaColoringProcess(file);
                } else {
                    alert('選択されていません');
                }
            });

            // Click event for the columnSeparation button
            document.getElementById('columnSeparationButton').addEventListener('click', function () {
                const file = window.selectedFile;
                if (file) {
                    // 翻訳セクションを表示する
                    document.getElementById('translationSection').style.display = 'block';
                    // 非表示
                    document.getElementById('columnSeparationButton').style.display = 'none';
                    document.getElementById('areaColoringButton').style.display = 'none';
                    document.getElementById('extractTextButton').style.display = 'none';
                    document.getElementById('translateTextButton').style.display = 'none';
                    document.getElementById('figureButton').style.display = 'none';
                    document.getElementById('drawTextButton').style.display = 'none';
                    document.getElementById('healthButton').style.display = 'none';
                    // 段組み分離処理を開始する
                    startSeparationProcess(file);
                } else {
                    alert('選択されていません');
                }
            });

            // Click event for the health check button
            document.getElementById('healthButton').addEventListener('click', function () {
                const file = window.selectedFile; // ファイル選択は不要だが、他のボタンとの整合性のため残す
                if (file) {
                    // 翻訳セクションを表示する
                    document.getElementById('translationSection').style.display = 'block';
                    // 非表示
                    document.getElementById('columnSeparationButton').style.display = 'none';
                    document.getElementById('areaColoringButton').style.display = 'none';
                    document.getElementById('extractTextButton').style.display = 'none';
                    document.getElementById('translateTextButton').style.display = 'none';
                    document.getElementById('figureButton').style.display = 'none';
                    document.getElementById('drawTextButton').style.display = 'none';
                    document.getElementById('healthButton').style.display = 'none';
                    // Healthチェック処理を開始する
                    startHealthCheckProcess();
                } else {
                    alert('ファイルが選択されていませんが、Healthチェックは実行します。');
                    startHealthCheckProcess(); // ファイル選択がなくてもHealthチェックは実行
                }
            });

            // 段組み分離処理を開始
            function startSeparationProcess(file) {
                // File validation
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    alert('PDFファイルのみ対応しています');
                    resetUpload();
                    return;
                }

                if (file.size > 16 * 1024 * 1024) {
                    alert('ファイルサイズが16MBを超えています');
                    resetUpload();
                    return;
                }

                // Update status
                updateStatus('段組み分離処理中...', 'processing');
                updateProgress(0);

                // Upload process (for columnSeparation)
                const formData = new FormData();
                formData.append('file', file);

                fetch('column_separation', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('columnSeparation failed');
                        }
                    })
                    .then(data => {
                        updateStatus('段組み分離完了', 'active');
                        updateProgress(100);

                        // 結果セクションを表示する
                        document.getElementById('resultSection').style.display = 'block';

                        // Display preview and download link
                        const pdfPreview = document.getElementById('pdf-preview');
                        const downloadPdfLink = document.getElementById('download-pdf');
                        const previewPlaceholder = document.querySelector('.preview-placeholder');

                        if (data && data.filename) {
                            const columnSeparationPdfUrl = `/preview/${data.filename}`;
                            pdfPreview.src = columnSeparationPdfUrl;
                            pdfPreview.style.display = 'block';
                            previewPlaceholder.style.display = 'none'; // プレースホルダーを非表示

                            downloadPdfLink.href = columnSeparationPdfUrl;
                            downloadPdfLink.download = data.filename;
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', data.filename);
                            document.getElementById('downloadButton').disabled = false;
                        } else {
                            // Use default filename if filename cannot be obtained
                            downloadPdfLink.href = '#';
                            downloadPdfLink.download = 'separated_document.pdf'; // Default File Name
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', 'separated_document.pdf');
                            document.getElementById('downloadButton').disabled = false;
                        }

                        // 処理時間と分離列数を表示
                        if (data.processing_time) {
                            document.getElementById('processingTime').textContent = data.processing_time;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateStatus('エラーが発生しました', 'error');
                        alert('段組み分離処理中にエラーが発生しました。もう一度お試しください。');
                        resetUpload();
                    });
            }

            // 領域色分け処理を開始
            function startAreaColoringProcess(file) {
                // File validation
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    alert('PDFファイルのみ対応しています');
                    resetUpload();
                    return;
                }

                if (file.size > 16 * 1024 * 1024) {
                    alert('ファイルサイズが16MBを超えています');
                    resetUpload();
                    return;
                }

                // Update status
                updateStatus('領域色分け処理中...', 'processing');
                updateProgress(0);

                // Upload process (for area coloring)
                const formData = new FormData();
                formData.append('file', file);

                fetch('/area_separation', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Area coloring failed');
                        }
                    })
                    .then(data => {
                        updateStatus('領域色分け完了', 'active');
                        updateProgress(100);

                        // 結果セクションを表示する
                        document.getElementById('resultSection').style.display = 'block';

                        // Display preview and download link
                        const pdfPreview = document.getElementById('pdf-preview');
                        const downloadPdfLink = document.getElementById('download-pdf');
                        const previewPlaceholder = document.querySelector('.preview-placeholder');

                        if (data && data.filename) {
                            const coloredPdfUrl = `/preview/${data.filename}`;
                            pdfPreview.src = coloredPdfUrl;
                            pdfPreview.style.display = 'block';
                            previewPlaceholder.style.display = 'none'; // プレースホルダーを非表示

                            downloadPdfLink.href = coloredPdfUrl;
                            downloadPdfLink.download = data.filename;
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', data.filename);
                            document.getElementById('downloadButton').disabled = false;
                        } else {
                            // Use default filename if filename cannot be obtained
                            downloadPdfLink.href = '#';
                            downloadPdfLink.download = 'colored_document.pdf'; // Default File Name
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', 'colored_document.pdf');
                            document.getElementById('downloadButton').disabled = false;
                        }

                        // 処理時間と色分け領域数を表示
                        if (data.processing_time) {
                            document.getElementById('processingTime').textContent = data.processing_time;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateStatus('エラーが発生しました', 'error');
                        alert('領域色分け処理中にエラーが発生しました。もう一度お試しください。');
                        resetUpload();
                    });
            }

            // テキスト抽出処理を開始
            function startExtractTextProcess(file) {
                // File validation
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    alert('PDFファイルのみ対応しています');
                    resetUpload();
                    return;
                }

                if (file.size > 16 * 1024 * 1024) {
                    alert('ファイルサイズが16MBを超えています');
                    resetUpload();
                    return;
                }

                // Update status
                updateStatus('テキスト抽出処理中...', 'processing');
                updateProgress(0);

                // Upload process (for text extraction)
                const formData = new FormData();
                formData.append('file', file);

                fetch('/extract_text', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Text extraction failed');
                        }
                    })
                    .then(data => {
                        updateStatus('テキスト抽出完了', 'active');
                        updateProgress(100);

                        // 結果セクションを表示する
                        document.getElementById('resultSection').style.display = 'block';

                        // Display preview and download link
                        const pdfPreview = document.getElementById('pdf-preview');
                        const downloadPdfLink = document.getElementById('download-pdf');
                        const previewPlaceholder = document.querySelector('.preview-placeholder');
                        const extractedTextDisplay = document.getElementById('extractedTextDisplay');
                        const extractedTextContent = document.getElementById('extractedTextContent');
                        extractedTextContent.innerHTML = ''; // Clear previous content

                        if (data && data.filename) {
                            const extractedPdfUrl = `/preview/${data.filename}`;
                            pdfPreview.src = extractedPdfUrl;
                            pdfPreview.style.display = 'block';
                            previewPlaceholder.style.display = 'none'; // プレースホルダーを非表示

                            downloadPdfLink.href = extractedPdfUrl;
                            downloadPdfLink.download = data.filename;
                            downloadPdfLink.style.display = 'block';
                            downloadPdfLink.textContent = '番号付きPDFをダウンロード';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', data.filename);
                            document.getElementById('downloadButton').textContent = '番号付きPDFをダウンロード';
                            document.getElementById('downloadButton').disabled = false;
                        } else {
                            // Use default filename if filename cannot be obtained
                            downloadPdfLink.href = '#';
                            downloadPdfLink.download = 'text_document.pdf'; // Default File Name
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', 'text_document.pdf');
                            document.getElementById('downloadButton').disabled = false;

                            // pdfPreview.style.display = 'none';
                            // previewPlaceholder.style.display = 'block';
                            // downloadPdfLink.style.display = 'none';
                            // document.getElementById('downloadButton').disabled = true;
                        }

                        if (data && data.text_filename) {
                            const extractedTextUrl = `/preview_text/${data.text_filename}`;
                            // テキストファイルの内容を直接取得して表示するのだ
                            fetch(extractedTextUrl)
                                .then(response => response.text())
                                .then(text => {
                                    extractedTextContent.textContent = text;
                                    extractedTextDisplay.style.display = 'block';
                                })
                                .catch(error => {
                                    console.error('Error fetching text file:', error);
                                    extractedTextContent.textContent = 'テキストファイルの読み込みに失敗したのだ。';
                                    extractedTextDisplay.style.display = 'block';
                                });
                        } else {
                            extractedTextContent.textContent = 'テキストが抽出されなかったのだ。';
                            extractedTextDisplay.style.display = 'block';
                        }

                        // 処理時間と抽出されたテキストブロック数を表示
                        if (data.processing_time) {
                            document.getElementById('processingTime').textContent = data.processing_time;
                        }
                        if (data.extracted_text_blocks) {
                            document.getElementById('translatedUnits').textContent = data.extracted_text_blocks;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateStatus('エラーが発生しました', 'error');
                        alert('テキスト抽出処理中にエラーが発生しました。もう一度お試しください。');
                        resetUpload();
                    });
            }

            // テキスト翻訳処理を開始
            function startTranslateTextProcess(file) {
                // File validation
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    alert('PDFファイルのみ対応しています');
                    resetUpload();
                    return;
                }

                if (file.size > 16 * 1024 * 1024) {
                    alert('ファイルサイズが16MBを超えています');
                    resetUpload();
                    return;
                }

                // Update status
                updateStatus('テキスト翻訳処理中...', 'processing');
                updateProgress(0);

                // Upload process (for text translation)
                const formData = new FormData();
                formData.append('file', file);

                fetch('/translate_text', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Text translation failed');
                        }
                    })
                    .then(data => {
                        updateStatus('テキスト翻訳完了', 'active');
                        updateProgress(100);

                        // 結果セクションを表示する
                        document.getElementById('resultSection').style.display = 'block';

                        // Display preview and download link
                        const pdfPreview = document.getElementById('pdf-preview');
                        const downloadPdfLink = document.getElementById('download-pdf');
                        const previewPlaceholder = document.querySelector('.preview-placeholder');
                        const extractedTextDisplay = document.getElementById('extractedTextDisplay');
                        const extractedTextContent = document.getElementById('extractedTextContent');
                        extractedTextContent.innerHTML = ''; // Clear previous content

                        if (data && data.filename) {
                            const translatedPdfUrl = `/preview/${data.filename}`;
                            pdfPreview.src = translatedPdfUrl;
                            pdfPreview.style.display = 'block';
                            previewPlaceholder.style.display = 'none'; // プレースホルダーを非表示

                            downloadPdfLink.href = translatedPdfUrl;
                            downloadPdfLink.download = data.filename;
                            downloadPdfLink.style.display = 'block';
                            downloadPdfLink.textContent = '翻訳済みテキストブロックPDFをダウンロード';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', data.filename);
                            document.getElementById('downloadButton').textContent = '翻訳済みテキストブロックPDFをダウンロード';
                            document.getElementById('downloadButton').disabled = false;
                        } else {
                            // Use default filename if filename cannot be obtained
                            downloadPdfLink.href = '#';
                            downloadPdfLink.download = 'japanese_document.pdf'; // Default File Name
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', 'japanese_document.pdf');
                            document.getElementById('downloadButton').disabled = false;

                            // pdfPreview.style.display = 'none';
                            // previewPlaceholder.style.display = 'block';
                            // downloadPdfLink.style.display = 'none';
                            // document.getElementById('downloadButton').disabled = true;
                        }

                        if (data && data.text_filename) {
                            const translatedTextUrl = `/preview_text/${data.text_filename}`;
                            // テキストファイルの内容を直接取得して表示するのだ
                            fetch(translatedTextUrl)
                                .then(response => response.text())
                                .then(text => {
                                    extractedTextContent.textContent = text;
                                    extractedTextDisplay.style.display = 'block';
                                })
                                .catch(error => {
                                    console.error('Error fetching translated text file:', error);
                                    extractedTextContent.textContent = '翻訳済みテキストファイルの読み込みに失敗したのだ。';
                                    extractedTextDisplay.style.display = 'block';
                                });
                        } else {
                            extractedTextContent.textContent = '翻訳済みテキストが抽出されなかったのだ。';
                            extractedTextDisplay.style.display = 'block';
                        }

                        // 処理時間と翻訳されたテキストブロック数を表示
                        if (data.processing_time) {
                            document.getElementById('processingTime').textContent = data.processing_time;
                        }
                        if (data.translated_text_blocks) {
                            document.getElementById('translatedUnits').textContent = data.translated_text_blocks;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateStatus('エラーが発生しました', 'error');
                        alert('テキスト翻訳処理中にエラーが発生しました。もう一度お試しください。');
                        resetUpload();
                    });
            }

            // Start figure process (currently same as translation process)
            function startFigureProcess(file) {
                // File validation
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    alert('PDFファイルのみ対応しています');
                    resetUpload();
                    return;
                }

                if (file.size > 16 * 1024 * 1024) {
                    alert('ファイルサイズが16MBを超えています');
                    resetUpload();
                    return;
                }

                // Update status
                updateStatus('画像処理中...', 'processing');
                updateProgress(0); // PDF解析開始で0%

                extractFigure(file);
            }

            function extractFigure(file) {
                const formData = new FormData();
                formData.append('file', file);

                // Reset progress bar
                updateProgress(0);

                // Upload process (for figure)
                fetch('/extract_figures', { // 図表抽出用のエンドポイントに変更
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Extract figures failed');
                        }
                    })
                    .then(data => {
                        // Post-figure processing (currently same as translation)
                        document.getElementById('step5').querySelector('p').textContent = 'デバッグ処理済みPDFの生成が完了しました。';
                        updateStatus('画像抽出完了', 'active');
                        updateProgress(100, 5); // STEP5, 100%

                        // Display result section
                        document.getElementById('resultSection').style.display = 'block';

                        // Display preview and download link
                        const pdfPreview = document.getElementById('pdf-preview');
                        const downloadPdfLink = document.getElementById('download-pdf');
                        const previewPlaceholder = document.querySelector('.preview-placeholder');

                        if (data && data.filename) {
                            const extractFigurePdfUrl = `/preview/${data.filename}`;
                            pdfPreview.src = extractFigurePdfUrl;
                            pdfPreview.style.display = 'block';
                            previewPlaceholder.style.display = 'none'; // プレースホルダーを非表示

                            downloadPdfLink.href = extractFigurePdfUrl;
                            downloadPdfLink.download = data.filename;
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', data.filename);
                            document.getElementById('downloadButton').disabled = false;
                        } else {
                            // Use default filename if filename cannot be obtained
                            downloadPdfLink.href = '#';
                            downloadPdfLink.download = 'figure_document.pdf'; // Default File Name
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', 'figure_document.pdf');
                            document.getElementById('downloadButton').disabled = false;
                        }

                        // Display processing time and number of translated units
                        if (data.processing_time) {
                            document.getElementById('processingTime').textContent = data.processing_time;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateStatus('エラーが発生しました', 'error');
                        alert('デバッグ処理中にエラーが発生しました。もう一度お試しください。');
                        resetUpload();
                    });
            }

            // 翻訳処理を開始
            function startDrawTextProcess(file) {
                // File validation
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    alert('PDFファイルのみ対応しています');
                    resetUpload();
                    return;
                }

                if (file.size > 16 * 1024 * 1024) {
                    alert('ファイルサイズが16MBを超えています');
                    resetUpload();
                    return;
                }

                // Update status
                updateStatus('翻訳処理中...', 'processing');
                updateProgress(0);

                // Upload process (for drawing translated text)
                const formData = new FormData();
                formData.append('file', file);

                fetch('/draw_text', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Draw text failed');
                        }
                    })
                    .then(data => {
                        updateStatus('翻訳完了', 'active');
                        updateProgress(100);

                        // 結果セクションを表示する
                        document.getElementById('resultSection').style.display = 'block';

                        // Display preview and download link
                        const pdfPreview = document.getElementById('pdf-preview');
                        const downloadPdfLink = document.getElementById('download-pdf');
                        const previewPlaceholder = document.querySelector('.preview-placeholder');

                        if (data && data.filename) {
                            const drawnPdfUrl = `/preview/${data.filename}`;
                            pdfPreview.src = drawnPdfUrl;
                            pdfPreview.style.display = 'block';
                            previewPlaceholder.style.display = 'none'; // プレースホルダーを非表示

                            downloadPdfLink.href = drawnPdfUrl;
                            downloadPdfLink.download = data.filename;
                            downloadPdfLink.style.display = 'block';
                            downloadPdfLink.textContent = '翻訳済みPDFをダウンロード';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', data.filename);
                            document.getElementById('downloadButton').textContent = '翻訳済みPDFをダウンロード';
                            document.getElementById('downloadButton').disabled = false;
                        } else {
                            // Use default filename if filename cannot be obtained
                            downloadPdfLink.href = '#';
                            downloadPdfLink.download = 'translated_document.pdf'; // Default File Name
                            downloadPdfLink.style.display = 'block';

                            // Enable download button and set filename
                            document.getElementById('downloadButton').setAttribute('data-filename', 'translated_document.pdf');
                            document.getElementById('downloadButton').disabled = false;

                            // pdfPreview.style.display = 'none';
                            // previewPlaceholder.style.display = 'block';
                            // downloadPdfLink.style.display = 'none';
                            // document.getElementById('downloadButton').disabled = true;
                        }

                        // 処理時間と描画されたテキストブロック数を表示
                        if (data.processing_time) {
                            document.getElementById('processingTime').textContent = data.processing_time;
                        }
                        if (data.drawn_text_blocks) {
                            document.getElementById('translatedUnits').textContent = data.drawn_text_blocks;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateStatus('エラーが発生しました', 'error');
                        alert('翻訳処理中にエラーが発生しました。もう一度お試しください。');
                        resetUpload();
                    });
            }

            // Healthチェック処理を開始
            function startHealthCheckProcess() {
                updateStatus('Healthチェック中...', 'processing');
                updateProgress(0);

                fetch('/health', {
                    method: 'GET' // GETリクエスト
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Health check failed');
                        }
                    })
                    .then(data => {
                        updateStatus('Healthチェック完了', 'active');
                        updateProgress(100);

                        // 結果セクションを表示する
                        document.getElementById('resultSection').style.display = 'block';

                        // Healthチェック結果を表示する
                        if (data && data.status) {
                            alert('Healthチェック結果: ' + data.status);
                        } else {
                            alert('Healthチェック結果が取得できなかったのだ。');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateStatus('エラーが発生しました', 'error');
                        alert('Healthチェック処理中にエラーが発生しました。もう一度お試しください。');
                        resetUpload();
                    });
            }

            // Convert file size to a human-readable format
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Update status
            function updateStatus(text, status) {
                document.getElementById('statusText').textContent = text;
                const statusDot = document.getElementById('statusDot');
                statusDot.className = 'status-dot';
                if (status === 'processing') {
                    statusDot.classList.add('processing');
                } else if (status === 'active') {
                    statusDot.classList.add('active');
                }
            }

            // Update step
            function updateStep(stepNumber, status) {
                const step = document.getElementById('step' + stepNumber);
                step.classList.remove('active', 'completed');
                step.classList.add(status);
            }

            // Update progress bar
            function updateProgress(overallProgress, stepNumber) {
                document.getElementById('progressFill').style.width = overallProgress + '%';
                document.getElementById('progressText').textContent = Math.round(overallProgress) + '%';

                // ステップごとの進捗を更新
                if (stepNumber !== undefined) {
                    // 全てのステップのactive/completedクラスをリセット
                    for (let i = 0; i <= 5; i++) {
                        const stepElement = document.getElementById('step' + i);
                        if (stepElement) {
                            stepElement.classList.remove('active', 'completed');
                        }
                    }

                    // 現在のステップをactiveにする
                    if (stepNumber > 0 && stepNumber <= 5) {
                        updateStep(stepNumber, 'active');
                    }

                    // 完了したステップをcompletedにする
                    for (let i = 1; i < stepNumber; i++) {
                        updateStep(i, 'completed');
                        const completedStepElement = document.getElementById('step' + i);
                        if (completedStepElement) {
                            const completedStepProgressText = completedStepElement.querySelector('.step-progress');
                            if (completedStepProgressText) {
                                completedStepProgressText.textContent = '100%';
                            }
                            // ここにメッセージ更新ロジックを追加
                            const completedStepParagraph = completedStepElement.querySelector('p');
                            if (completedStepParagraph) {
                                if (i === 1) {
                                    completedStepParagraph.textContent = 'PDFファイルの解析が完了しました。';
                                } else if (i === 2) {
                                    completedStepParagraph.textContent = 'テキストの結合が完了しました。';
                                } else if (i === 3) {
                                    completedStepParagraph.textContent = 'LLMによる翻訳処理が完了しました。';
                                } else if (i === 4) {
                                    completedStepParagraph.textContent = '翻訳結果のレイアウト調整が完了しました。';
                                }
                            }
                        }
                    }

                    // 全体進捗が100%になったら現在のステップをcompletedにする
                    if (overallProgress === 100 && stepNumber > 0 && stepNumber <= 5) {
                        updateStep(stepNumber, 'completed');
                        const completedStepElement = document.getElementById('step' + stepNumber);
                        if (completedStepElement) {
                            const completedStepProgressText = completedStepElement.querySelector('.step-progress');
                            if (completedStepProgressText) {
                                completedStepProgressText.textContent = '100%';
                            }
                            const completedStepParagraph = completedStepElement.querySelector('p');
                            if (completedStepParagraph) {
                                if (stepNumber === 5) {
                                    completedStepParagraph.textContent = '翻訳済みPDFの生成が完了しました。';
                                }
                            }
                        }
                    }

                    // ステップごとのパーセンテージを計算して更新
                    let stepProgress = 0;
                    if (stepNumber === 1) { // PDF解析 (0% - 10%)
                        stepProgress = Math.min(100, Math.max(0, overallProgress / 0.1));
                    } else if (stepNumber === 2) { // テキスト結合 (10% - 20%)
                        stepProgress = Math.min(100, Math.max(0, (overallProgress - 10) / 0.1));
                    } else if (stepNumber === 3) { // 翻訳処理 (20% - 80%)
                        stepProgress = Math.min(100, Math.max(0, (overallProgress - 20) / 0.6));
                    } else if (stepNumber === 4) { // レイアウト調整 (80% - 90%)
                        stepProgress = Math.min(100, Math.max(0, (overallProgress - 80) / 0.1));
                    } else if (stepNumber === 5) { // PDF生成 (90% - 100%)
                        stepProgress = Math.min(100, Math.max(0, (overallProgress - 90) / 0.1));
                    }

                    if (stepNumber > 0 && stepNumber <= 5) {
                        const stepElement = document.getElementById('step' + stepNumber);
                        if (stepElement) {
                            const stepProgressText = stepElement.querySelector('.step-progress');
                            if (stepProgressText) {
                                stepProgressText.textContent = `${Math.round(stepProgress)}%`;
                            }
                        }
                    }
                }
            }

            // ファイルをダウンロード
            function downloadFile(filename) {
                const downloadUrl = `/download/${filename}`;

                // Create download link
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                link.target = '_blank';

                // Start download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Disable button after download completion
                this.disabled = true;
                this.textContent = 'ダウンロード中...';

                // Enable button after 3 seconds
                setTimeout(() => {
                    this.disabled = false;
                    this.textContent = '翻訳済みPDFをダウンロード';
                }, 3000);
            }

            // Reset upload
            function resetUpload() {
                document.getElementById('fileInput').value = '';
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('uploadArea').style.display = 'block';
                document.getElementById('translationSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('extractedTextDisplay').style.display = 'none'; // Hide extracted text display
            }

            // File delete button
            document.getElementById('removeButton').addEventListener('click', function () {
                resetUpload();
            });

            // Download button
            document.getElementById('downloadButton').addEventListener('click', function () {
                const filename = this.getAttribute('data-filename');
                if (filename) {
                    // Execute download process
                    downloadFile(filename);
                } else {
                    alert('ダウンロードするファイルがありません');
                }
            });

            // Translate new file button
            document.getElementById('newButton').addEventListener('click', function () {
                resetUpload();
            });

            // Drag and drop functionality
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function () {
                this.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function (e) {
                e.preventDefault();
                this.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length) {
                    const file = files[0];
                    if (file.type === 'application/pdf') {
                        // ファイル情報を表示
                        document.getElementById('fileName').textContent = file.name;
                        document.getElementById('fileSize').textContent = formatFileSize(file.size);
                        document.getElementById('fileInfo').style.display = 'block';

                        // アップロードエリアを非表示
                        document.getElementById('uploadArea').style.display = 'none';

                        // 翻訳セクションはまだ表示しない
                        // document.getElementById('translationSection').style.display = 'block';

                        // ファイル選択後に翻訳開始ボタンを表示する
                        document.getElementById('columnSeparationButton').style.display = 'block';
                        document.getElementById('areaColoringButton').style.display = 'block';
                        document.getElementById('extractTextButton').style.display = 'block';
                        document.getElementById('translateTextButton').style.display = 'block';
                        document.getElementById('figureButton').style.display = 'block';
                        document.getElementById('drawTextButton').style.display = 'block';
                        document.getElementById('healthButton').style.display = 'block';

                        // 選択されたファイルを保存する
                        window.selectedFile = file;
                    } else {
                        alert('PDFファイルのみ対応しています。');
                    }
                }
            });
        </script>
</body>

</html>
# PDF翻訳Webアプリ 仕様設計書

## 1. 概要 (Overview)

本Webアプリは、ユーザーからアップロードされたPDFファイル（主に英語）を受け取り、生成AI（OpenAI互換API）を使用して内容を日本語に翻訳し、元のレイアウトを極力維持した状態で元の英語テキストを翻訳済みの日本語テキストで上書きした新しいPDFファイルとして出力します。

## 2. 機能要件 (Functional Requirements)

### ルーティング設定

#### `/`: index (ホームページ)

| No. | 機能 | モジュール | 詳細 |
| ---- | --- | ---- | ---- |
| FR-01 | PDFファイルのアップロード | | ユーザーインターフェースからPDFファイルを受け付ける。 |
| FR-02 | テキストの抽出と構造解析 (テキスト) | `pdf_text_manager.py` | `pdf_text_manager.py` は `pdfminer.six` を使用してPDFからすべてのテキストブロック、 **その座標、フォント情報（サイズ、種類、スタイル）** を正確に抽出・解析し、最大ページ数制限を適用する。 |
| FR-03 | 図表の抽出と構造解析 | `figure_extractor.py` | `figure_extractor.py` は、画像、図中のテキスト、テーブル候補などの図表の領域を特定し、そのタイプ、座標、画像データ（一時ファイルパス）、テキスト内容などの情報を抽出する。 |
| FR-04 | 翻訳単位の決定と結合 | `pdf_document_manager.py` | 抽出された微細なテキストブロックを、ページごとにグループ化し、バウンディングボックスとフォント情報（サイズ、スタイル）の類似性に基づいて意味的に一貫した文章・段落（翻訳単位）に結合する。 |
| FR-05 | 生成AIによる翻訳 | `translator.py` | 結合された翻訳単位のテキストをOpenAI互換API (llama.cpp) に送信し、日本語翻訳文を取得する。`translator.py` は、APIのURL、モデル、タイムアウトなどの設定を管理し、翻訳リクエストの送信、レスポンスの処理、エラーハンドリング、リトライ処理、翻訳テキストの長さ制限や無効な文字のチェックなどの入力バリデーション、翻訳結果のフォーマット（不要なプレフィックス・サフィックスの削除、空白の除去など）を行う。 |
| FR-06 | テキストの上書き・レイアウト維持 | `pdf_document_manager.py` | 元の英語テキストの領域を白色の矩形で覆い隠し、取得した日本語翻訳文をその領域に挿入（上書き）する。 |
| FR-07 | テキストのレイアウト調整 | `pdf_text_layout.py` | テキストの行分割計算、フォントサイズの自動調整、バウンディングボックスの拡張を行い、`pypdf` と `ReportLab` を使用して元のフォントサイズ、行間、字下げなどのレイアウト情報を可能な限り再現する。 |
| FR-08 | PDFファイルの出力 | `pdf_document_manager.py` | 翻訳・上書き処理が完了したPDFファイルを生成し、指定されたパスに保存後、ユーザーにダウンロード可能にする。 |

#### `/extract_figures`: PDFファイルから図表を抽出

| No. | 機能 | モジュール | 詳細 |
| ---- | --- | ---- | ---- |
| FR-03 | 図表の抽出と構造解析 | `figure_extractor.py` | （省略） |
| FR-09 | 図表のみのPDF生成 | `figure_extractor.py` | 抽出された図表情報に基づき、画像、図中のテキスト、テーブル候補のみを含む新しいPDFファイルを生成する。抽出された画像はBMPからPNGに変換され、元のPDFのページ番号とともに描画される。 |

#### `/health`: ヘルスチェック

| No. | 機能 | モジュール | 詳細 |
| ---- | --- | ---- | ---- |
| FR-10 | 翻訳APIのヘルスチェック | `translator.py` | 翻訳API (llama.cpp) のヘルスチェックを行い、APIのURL、モデル、利用可能なモデルの情報を取得する。 |

### その他

| No. | 機能 | モジュール | 詳細 |
| ---- | --- | ---- | ---- |
| FR-11 | レイアウトユーティリティ機能 | `pdf_text_layout.py` | 矩形の重なり判定やバウンディングボックスの拡張など、レイアウト調整に必要なユーティリティ機能を提供する。 |
| FR-12 | エラーハンドリング | `pdf_document_manager.py` | ファイルの存在チェック、出力ディレクトリの作成、翻訳API通信エラー、組版エラー、予期せぬエラーなどを適切に処理し、ユーザーに通知する。 |
| FR-13 | 日本語フォントの管理と描画 | `pdf_text_layout.py` | 指定された日本語フォントをReportLabに登録し、翻訳済みテキストの描画に利用する。フォントファイルの存在チェックと登録エラーハンドリングを行う。 |
| FR-14 | テスト用PDFファイルの生成 | `gen_sample_pdf.py` | テキスト、画像、テーブル候補を含む複数ページのテスト用PDFファイルを生成する。このプロセスには、一時的なダミー画像ファイルの生成と、PDF作成後の削除が含まれる。 |

## 3. 非機能要件 (Non-Functional Requirements)

| 項目 | 要件 |
| ---- | ---- |
| パフォーマンス | 標準的なA4サイズ（10ページ程度）のPDFであれば、翻訳完了まで5分以内とする（API応答時間除く）。 |
| 信頼性 | PDF処理のエラー発生率は0.1%未満とする。エラー発生時は原文PDFへの影響を避ける。 |
| セキュリティ | OpenAI互換APIへの通信はTLS/SSL暗号化を使用する。アップロードされたファイルは翻訳完了後、48時間後に自動的に削除する。 |
| 保守性 | モジュール化されたコード構造とし、PDF解析、翻訳API連携、組版ロジックの各モジュールが独立してテスト・更新できるようにする。 |

## 4. システム構成 (System Architecture)

シンプルなマイクロサービスまたはモノリシックなバックエンドアプリケーションとして設計します。

1. フロントエンド (UI): ユーザーからのファイルアップロード、翻訳開始指示、翻訳済みファイルダウンロードのインターフェースを提供する。（例: HTML/CSS/JavaScript）
2. バックエンド (Core Logic):
    - Pythonで実装します。
    - PDF処理モジュール: `pdfminer.six`、`pypdf`、`ReportLab` などのライブラリを利用し、PDF解析、テキスト抽出、座標取得、最終的なPDFの編集・出力を行う。
    - 翻訳管理モジュール: 翻訳単位の管理とAIへのAPIコールを担う。
    - 組版/レイアウト調整モジュール: 英語と日本語の文字幅の違いを考慮し、元の座標とフォント情報に基づいて最適な改行位置とフォントサイズを動的に計算するロジックを内包する。
3. 外部サービス:
    - OpenAI互換API: 翻訳テキストを生成する。OpenAI互換APIは llama.cpp で提供されます。（現状ではローカル環境のみがターゲットのため、APIキーはデフォルトのままです。Dockerコンテナの中からアクセスする場合のAPIエンドポイントは `http://host.docker.internal:11435` です）

## 5. 詳細設計：PDF処理と組版ロジック

「PDF上の該当部分を日本語の文章で上書き」し、「レイアウトを維持」する核心的なプロセスを設計します。

### 5.1. PDF解析フェーズ

1. ページループ: PDFの全ページを順次処理する。
2. テキストブロック抽出: `pdfminer.six` などのライブラリを使用し、ページ内の全テキストブロックを取得。各ブロックは以下の情報を持つ。
    - bbox: バウンディングボックス（四隅の座標）
    - text: 抽出されたテキスト文字列（英語）
    - font_size: フォントサイズ
    - font_name: フォント名
3. 翻訳単位結合ロジック (FR-04):
    - 垂直方向の近接性（行間）、水平方向の位置合わせ（インデント）、同じフォント情報に基づいて、隣接するブロックを一つの意味的な段落として結合する。

### 5.2. 翻訳フェーズ (FR-05)

1. APIコール: 結合された各段落（翻訳単位）をAPIに送信。
2. プロンプト設計: 翻訳の精度と形式を指示するため、以下のメタ情報をプロンプトに含める。
    - 原文のフォント情報（太字、イタリック、リスト形式など）を維持する指示。
    - 翻訳後のテキストが原文の領域に収まるよう、簡潔かつ自然に翻訳する指示。

### 5.3. 組版・上書きフェーズ (FR-05, FR-06, FR-07)

このフェーズは、レイアウト維持のための最も複雑な部分です。

1. 原文の削除: 翻訳が完了した段落について、元の英語テキストが占めていた領域（bbox）を特定し、その領域を新しいテキストを挿入するためのプレースホルダーとして確保する（または白色でクリアする）。
2. 新規テキストの配置計算（組版）:
    - 最大幅の決定: 元の英語テキストのbboxの幅を、日本語テキストが利用できる最大幅として設定する。
    - 動的な改行処理: 日本語翻訳文を、元の英語のフォントサイズと行間、および決定した最大幅に基づき、自動で改行位置を計算し、元の文章の垂直方向の開始座標から配置していく。
    - フォント埋め込み: 新規の日本語フォント（例: IPAex明朝など）をPDFに埋め込み、テキストを描画する。
3. レイアウト調整: 翻訳後のテキストの長さにより、段落全体の高さ（垂直方向のbbox）が変わる可能性がある。この変化が後続のテキストの配置に影響を与えないよう、以下の対応を取る。
    - 微調整: 翻訳後のテキストの高さが元の高さと大きく異なる場合、後続のテキストブロックの垂直座標を微量にシフトさせるロジックが必要となる（難易度が高いため、まずは「大幅なズレを防ぐ」ことを優先する）。

新規行数=⌈ 元の英語の bbox の幅×元のフォントサイズ / 日本語テキストの全長×日本語フォント幅 ⌉

※ この計算は簡略化した概念であり、実際の組版はより複雑な処理が必要な可能性があります。

## 6. モジュール設計

### 6.1 メインアプリケーション (app/main.py)

**役割**: Webアプリケーションのエントリーポイント

**主要機能**:
- Flaskアプリケーションの初期化
- ルーティング設定
- エラーハンドリング
- ファイルアップロード/ダウンロード処理
- PDFプレビュー処理
- ヘルスチェック機能
- 図表抽出機能

**設計**:
- `create_app()`ファクトリ関数
- 環境ごとの設定管理
- 基本的なエラーハンドリング

### 6.2 設定管理 (app/config.py)

**役割**: アプリケーションの設定を一元管理

**設定項目**:
- 環境ごとの設定（開発/本番）
- ディレクトリパス設定
- API設定
- 日本語フォント設定
- PDF処理設定
- 翻訳設定
- レイアウト調整設定

**環境変数**:
- `TRANSLATION_API_URL`: 翻訳APIのURL
- `TRANSLATION_MODEL`: 使用するモデル
- `JAPANESE_FONT_PATH`: 日本語フォントのパス
- `LOG_LEVEL`: ログレベル

### 6.3 LLM連携モジュール (app/llm.py)

**役割**: OpenAI互換API (llama.cpp) との低レベルな通信を管理します。

**主要機能**:
- APIエンドポイント、モデル、タイムアウト設定の管理
- APIヘルスチェック機能
- モデル情報取得機能
- 翻訳プロンプトの生成（XML形式）
- 翻訳リクエストの送信とレスポンスの処理
- エラーハンドリングとリトライ処理

**APIエンドポイント**: `http://host.docker.internal:11435`

### 6.4 翻訳管理モジュール (app/translator.py)

**役割**: 翻訳API連携と翻訳結果の整形、バリデーションを行う。

**主要機能**:
- `LLM` モジュールを利用したテキストの翻訳リクエスト送信
- 翻訳結果のクリーニング（不要なプレフィックス・サフィックスの削除、空白の除去など）
- 翻訳結果のバリデーション（無効な翻訳の検出）
- リトライ処理
- 数式や記号の翻訳スキップ判定

### 6.5 PDFテキスト管理モジュール (app/pdf_text_manager.py)

**役割**: PDFからのテキスト抽出と、PDFページ上でのテキストの削除・描画を行います。

**主要機能**:
- `pdfminer.six` を使用したテキストブロックの抽出（座標、フォント情報を含む）
- 抽出されたテキストブロックの整形
- 指定されたバウンディングボックス内の元のテキストを白色の矩形で覆い隠す
- 翻訳済みテキストをPDFページ上の指定された位置に描画する

### 6.6 PDFレイアウト計算モジュール (app/pdf_text_layout.py)

**役割**: 翻訳済みテキストのレイアウト計算と調整、および描画ユーティリティを提供します。

**主要機能**:
- 日本語フォントの登録と管理
- 翻訳済みテキストを指定された最大幅とフォントサイズに基づいて複数行に分割する
- 日本語と英語の文字幅の違いを考慮した改行処理
- テキストが指定された領域に収まるようにフォントサイズを動的に調整する
- 矩形の重なり判定
- バウンディングボックスの拡張

### 6.7 PDFドキュメント管理モジュール (app/pdf_document_manager.py)

**役割**: PDFドキュメント全体の処理フローを管理し、翻訳済みPDFの生成を調整します。

**主要機能**:
- オリジナルPDFの読み込みと出力PDFの書き出し
- `PdfTextManager` を利用したテキストの抽出と結合
- `Translator` を利用したテキストの翻訳
- `PdfTextLayout` を利用したテキストの削除と描画
- 抽出された微細なテキストブロックを翻訳単位に結合するロジック
- エラーハンドリングとファイル操作（存在チェック、ディレクトリ作成）

### 6.8 図表抽出モジュール (app/figure_extractor.py)

**役割**: PDFから図表（画像、図中のテキスト、テーブル候補）を抽出し、図表のみのPDFを生成します。

**主要機能**:
- `pdfminer.six` を使用した図表要素の検出と抽出
- 抽出された画像データの処理（BMPからPNGへの変換）
- 抽出された図表情報に基づいた新しいPDFファイルの生成
- 図表の座標正規化

### 6.9 サンプルPDF生成モジュール (app/gen_sample_pdf.py)

**役割**: テスト用のPDFファイルを生成するスクリプトです。

**主要機能**:
- テキスト、画像、テーブル候補を含む複数ページのPDFファイルを生成
- ダミー画像ファイルの生成とクリーンアップ

### 6.10 ユーティリティモジュール (app/utils.py)

**役割**: アプリケーション全体で利用される汎用的なユーティリティ関数を提供します。

**主要機能**:
- ロギング設定
- ディレクトリの存在確認と作成
- 古いファイル（一時ファイルなど）のクリーンアップ
- 一意なファイル名の生成
- PDFファイルのバリデーション
- ファイルサイズのフォーマット
- 翻訳プロンプトの生成
- テキストブロックの結合
- テキストの寸法計算
- 処理ログの保存と読み込み
- ファイルのバックアップ作成

## 7. 技術スタック (Technology Stack)

| カテゴリ | 技術 | 備考 |
| -------- | ---- | ---- |
| バックエンド | Python + Flask | Flask標準機能のみを使用し、最小限の依存関係で実装 |
| PDF処理 | pdfminer.six / pypdf / ReportLab | テキスト抽出、座標取得、PDF編集機能 |
| 翻訳API | llama.cpp | OpenAI互換API (http://localhost:11435)、認証なし |
| フロントエンド | HTML/CSS/JavaScript | JavaScriptはFetch APIのみを使用 |
| フォント | IPAex明朝 (ipaexm.ttf) | 商用利用可能な無償フォント |
| コンテナ化 | Docker Compose | 開発・テスト・デプロイ環境を統一 |
| 非同期処理 | なし | まずはシンプルな同期処理で実装を試みる |

## 8. ディレクトリ構成 (Directory Structure)

```
tardis/
├── app/
│   ├── __init__.py          # 空ファイル（パッケージ化）
│   ├── config.py            # 設定ファイル
│   ├── figure_extractor.py  # 図表抽出モジュール
│   ├── gen_sample_pdf.py    # サンプルPDF生成スクリプト
│   ├── main.py              # メインアプリケーション
│   ├── pdf_document_manager.py # PDFドキュメント管理モジュール
│   ├── pdf_text_layout.py   # PDFテキストレイアウト計算モジュール
│   ├── pdf_text_manager.py  # PDFテキスト削除・描画モジュール
│   ├── translator.py        # 翻訳API連携モジュール
│   └── utils.py             # ユーティリティ関数
├── static/
│   ├── css/
│   ├── js/
│   └── fonts/               # IPAex明朝フォントファイル
├── templates/
│   └── index.html           # メインページ
├── tests/
├── uploads/                 # 一時アップロードファイル
├── outputs/                 # 翻訳済みPDF出力
├── docker-compose.yml
├── Dockerfile
├── requirements.txt
└── README.md
```

## 9. システムワークフロー (System Workflow)

### 9.1. ファイル処理の流れ

1. **ユーザーからのPDFアップロード**
   - フロントエンドからPDFファイルをバックエンドにアップロード
   - ファイルは一時ディレクトリ（`uploads/`）に保存

2. **PDF解析とテキスト抽出**
   - `pdfminer.six` などのライブラリを使用してPDFを解析
   - 各ページのテキストブロック、座標、フォント情報を抽出
   - 抽出情報をデータ構造化して保存

3. **翻訳単位の結合**
   - 抽出された微細なテキストブロックを意味的に結合
   - 段落や文章単位にグループ化

4. **翻訳APIへのリクエスト**
   - 結合された翻訳単位をllama.cpp APIに送信
   - 日本語翻訳文を取得

5. **レイアウト調整とPDF上書き**
   - 元の英語テキストの領域を削除
   - 日本語翻訳文を元のレイアウトに合わせて配置
   - IPAex明朝フォントを使用してPDFを更新

6. **翻訳済みPDFの出力**
   - 完成したPDFファイルを`outputs/`ディレクトリに保存
   - ユーザーにダウンロードリンクを提供

### 9.2. エラーハンドリングの流れ

1. **ファイルアップロード時**
   - ファイル形式の検証（PDFのみ許可）
   - ファイルサイズの制限 (16MB)

2. **PDF処理時**
   - 破損したPDFファイルの検出
   - テキスト抽出エラーの検出

3. **翻訳API時**
   - API接続エラーのハンドリング
   - レスポンス形式の検証

4. **PDF生成時**
   - 組版エラーの検出
   - フォント埋め込みエラーのハンドリング

## 10. 開発環境設定 (Development Environment)

### 10.1. 前提条件

- Python 3.8+
- Docker
- Docker Compose
- llama.cpp（ローカル環境で実行）

### 10.2. 開発環境の起動

```bash
# Docker Composeを使用して開発環境を起動
docker-compose up -d

# アプリケーションにアクセス
# http://localhost:5000
```

### 10.3. 開発時の注意点

- ファイルのアップロードは`uploads/`ディレクトリに一時保存
- 翻訳済みPDFは`outputs/`ディレクトリに出力
- 開発中はエラーログをコンソールに出力
- テストファイルは`tests/`ディレクトリに配置

## 11. クオリティ保証

### 11.1 パフォーマンス要件
- 標準的なA4サイズ（10ページ程度）のPDFであれば、翻訳完了まで5分以内（API応答時間除く）

### 11.2 信頼性要件
- PDF処理のエラー発生率は0.1%未満
- エラー発生時は原文PDFへの影響を避ける

### 11.3 セキュリティ要件
- アップロードされたファイルは翻訳完了後、48時間後に自動的に削除

### 11.4 保守性要件
- モジュール化されたコード構造
- PDF解析、翻訳API連携、組版ロジックの各モジュールが独立してテスト・更新可能
- Pythonソースコード上のコメントやログメッセージは英語に統一
    - 原則としてグロービッシュやスペシャル・イングリッシュを使用する、つまり非英語圏の人でも読みやすい平易な英語を使用する
- アプリユーザーへのメッセージは日本語で統一
    
### 11.5. テストコード
- 単体テストとして、ファイルアップロード時のエラーハンドリング（ファイルサイズ超過、拡張子不正、ディスク容量不足、PDF解析エラー）を網羅するテストスイートを `tests/test_upload_errors.py` に作成しました。
- 図表抽出機能の単体テストと統合テストを `tests/test_figure_extraction.py` に作成しました。

### 11.6. テストの実行方法
テストは仮想環境を使用して実行します。以下のコマンドでテストを実行できます。

```bash
. ~/tardis/bin/activate
PYTHONPATH=.
pytest tests/test_figure_extraction.py
```
